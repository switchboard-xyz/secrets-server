{{- $values := .Values -}}

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: secrets-server
  name: secrets-server-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: secrets-server
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: secrets-server
        should_scrape: scrape
    spec:
      containers:
      - env:
        -
          name: CONFIGS
          value: {{ .Files.Get "configs.jsonc" | quote }}
      image: {{ $values.image }}
      imagePullPolicy: Always
      name: secrets-server
      securityContext:
        privileged: true
      ports:
      - name: web
        containerPort: 9090
        protocol: TCP
      - name: liveness-port
        containerPort: 8080
        protocol: TCP

      startupProbe:
        httpGet:
          path: /healthz
          port: liveness-port
        initialDelaySeconds: 5
        failureThreshold: 30
        periodSeconds: 5
        timeoutSeconds: 10
     volumeMounts:
     - mountPath: /home/credentials/
       name: google-cloud-key
     - mountPath: /var/run/aesmd
       name: var-run-aesmd
     - mountPath: /dev/sgx/enclave
       name: dev-sgx-enclave
     - mountPath: /dev/sgx/provision
       name: dev-sgx-provision
   volumes:
   - name: var-run-aesmd
     hostPath:
       path: /var/run/aesmd/
   - name: dev-sgx-enclave
     hostPath:
       path: /dev/sgx/enclave
   - name: dev-sgx-provision
     hostPath:
       path: /dev/sgx/provision




